<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ace</title>
    <meta name="description" content="Generate interactive CVs" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better mobile feel in preview areas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- TYPES ---
        // We now treat SectionType as string to allow dynamic sections
        type SectionType = string;

        interface CVItem {
            id: string;
            section: SectionType;
            title: string;
            subtitle?: string;
            date?: string;
            location?: string;
            content: string;
            links?: { label: string; url: string }[];
            granularity: number[];
        }

        interface GranularityLevel {
            level: number;
            name: string;
            description: string;
        }

        interface CVData {
            personalInfo: {
                name: string;
                pronouns: string;
                tagline: string;
                email: string;
                phone: string;
                location: string;
                linkedin: string;
                github: string;
                website: string;
                calendly: string;
                image: string; // Base64 or URL
            };
            sectionOrder: string[];
            items: CVItem[];
        }



        interface CVRecord {
            id: string;
            name: string;
            createdAt: number;
            updatedAt: number;
            data: CVData;
        }

        interface CVVersion {
            id: string;
            cvId: string;
            createdAt: number;
            label: string;
            data: CVData;
        }

        interface GeneratorConfig {
            employerName: string;
            googleSheetUrl: string;
            defaultLevel: number;
            levels: GranularityLevel[];
            includeTestButton: boolean;
            exportSessionId: string;
        }

        // --- CONSTANTS ---
        const DEFAULT_LEVELS: GranularityLevel[] = [
            { level: 1, name: 'Pitch', description: 'The elevator pitch' },
            { level: 2, name: 'Education', description: 'Academic background' },
            { level: 3, name: 'Experience', description: 'Key professional roles' },
            { level: 4, name: 'Policy & Advocacy', description: 'Specific policy work' },
            { level: 5, name: 'Projects', description: 'Key deliverables' },
            { level: 6, name: 'Writings', description: 'Publications and research' },
            { level: 7, name: 'Honors', description: 'Awards and recognition' },
            { level: 8, name: 'Service', description: 'Volunteering and organizations' },
            { level: 9, name: 'Learning', description: 'Courses and conferences' },
            { level: 10, name: 'Complete CV', description: 'Everything' },
        ];

        const DEFAULT_SECTIONS = [
            'Profile', 'Education', 'Experience', 'Projects', 'Writings', 
            'Awards', 'Certificates', 'Organisations', 'Skills', 'Interests', 'References'
        ];

        const INITIAL_CV_DATA: CVData = {
            personalInfo: {
                name: 'Mohit Gaur',
                pronouns: 'he/him',
                tagline: 'Law Student | Interested in Public Policy & People-Centric Reform',
                email: 'mohitgaur22118@rgnul.ac.in',
                phone: '6397609838',
                location: 'Delhi, India',
                linkedin: 'https://www.linkedin.com/in/mohit-gaur-1590a2265/',
                github: 'github.com/mohitgaurRGNUL',
                website: 'mohitgaur22118-rgnul',
                calendly: '',
                image: 'https://picsum.photos/200/200'
            },
            sectionOrder: DEFAULT_SECTIONS,
            items: [
                {
                    id: 'profile-1',
                    section: 'Profile',
                    title: 'About Me',
                    content: "I'm a utopian empiricist aiming for the realisation of the interests of all. On one ordinary day in 2018, I started meeting and conversing with Indian legislators to table a private member's bill in Parliament to amend the Prevention of Cruelty to Animals Act, 1960. In essence, I'm a generalist targeting both breadth and depth of expertise in the evidence-based policy space in India.",
                    granularity: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'edu-1',
                    section: 'Education',
                    title: 'B.A. LL.B. (Hons), Law',
                    subtitle: 'The Rajiv Gandhi National University of Law, Patiala',
                    location: 'Patiala, Punjab',
                    date: '08/2022 – Present',
                    content: 'All India Rank: 864. Activities: Moot Court, Debate, ADR. Projects include Olga Tellis, grundnorm across constitutions, AI human privilege.',
                    granularity: [2, 3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'exp-1',
                    section: 'Experience',
                    title: 'Associate Editor',
                    subtitle: 'RGNUL Student Research Review (RSRR)',
                    location: 'Patiala, Punjab',
                    date: '08/2023 – 08/2024',
                    content: 'Reviewed incoming manuscripts; pitched impact investing, biosafety, and criminal law reforms.',
                    granularity: [3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'exp-2',
                    section: 'Experience',
                    title: 'Intern',
                    subtitle: 'People For Animals Official',
                    location: 'Delhi, India',
                    date: '01/2023 – 01/2023',
                    content: 'Interned under Smt. Maneka Sanjay Gandhi. Effected meaningful functioning of official email. Rescued animals under Section 34 PCA Act 1960.',
                    granularity: [3, 4, 5, 6, 7, 8, 9, 10]
                }
            ]
        };

        const ANALYTICS_GUIDE_MD = `# Setting up Google Sheets Analytics for Ace

This guide explains how to create a backend for your CV using Google Sheets to track who views your CV and at what granularity.

## 1. Create a Google Sheet
1. Go to [sheets.google.com](https://sheets.google.com) and create a new sheet.
2. Name it "CV Analytics" (or anything you like).
3. In the first row, create these headers:
   - **A1**: timestamp
   - **B1**: employer
   - **C1**: durationSeconds
   - **D1**: maxScrollPercentage
   - **E1**: finalGranularity

## 2. Create the Apps Script
1. In your Google Sheet, go to **Extensions > Apps Script**.
2. Delete any code in the \`Code.gs\` file and paste the following:

\`\`\`javascript
function doPost(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);
    
    sheet.appendRow([
      data.timestamp,
      data.employer,
      data.durationSeconds,
      data.maxScrollPercentage,
      data.finalGranularity
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({"status": "success"}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({"status": "error", "message": error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
\`\`\`

## 3. Deploy as Web App
1. Click the blue **Deploy** button > **New deployment**.
2. Click the gear icon next to "Select type" and choose **Web app**.
3. Fill in the details:
   - **Description**: CV Analytics Receiver
   - **Execute as**: Me (your email)
   - **Who has access**: **Anyone** (This is crucial so the CV can send data without login).
4. Click **Deploy**.
5. Copy the **Web app URL** generated (it ends in \`/exec\`).

## 4. Use the URL
Paste this URL into the "Google Sheet Web App URL" field in Ace.
`;

        // --- SERVICE ---
        const generateCVHTML = (data: CVData, config: GeneratorConfig): string => {
            const serializedData = JSON.stringify(data).replace(/`/g, '\\`');
            const serializedConfig = JSON.stringify(config).replace(/`/g, '\\`');
            
            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.personalInfo.name} - CV</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Merriweather', serif; }
        .sans { font-family: 'Inter', sans-serif; }
        .slider-thumb::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2563eb;
            cursor: pointer;
            margin-top: -8px;
        }
        .slider-track::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 2px;
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print {
            .page-break { page-break-before: always; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen pb-20">

    <!-- Sticky Header for Controls -->
    <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-200 p-4 print:hidden">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex flex-col w-full md:w-2/3">
                <div class="flex justify-between text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                    <span id="level-name">Level ${config.defaultLevel}: Loading...</span>
                    <span>Granularity ${config.levels.length}</span>
                </div>
                <input type="range" min="1" max="10" value="${config.defaultLevel}" id="granularity-slider" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex items-center gap-2">
                <div class="text-xs text-slate-400 font-semibold uppercase tracking-wide hidden sm:block">Ace Viewer</div>
                <div class="text-xs text-slate-400 font-mono hidden sm:block">
                    Viewing as: <span class="font-bold text-slate-600">${config.employerName}</span>
                </div>
                ${config.includeTestButton ? `<button onclick="testAnalytics()" class="ml-2 px-2 py-1 bg-amber-100 text-amber-800 text-xs rounded border border-amber-300 hover:bg-amber-200">Test Analytics</button>` : ''}
            </div>
        </div>
    </div>

    <!-- CV Container -->
    <main id="cv-root" class="max-w-4xl mx-auto p-6 md:p-12 shadow-2xl bg-white mt-4 md:mt-8 mb-12 min-h-[1100px] print:shadow-none print:mt-0 print:p-0">
        <!-- Content injected via JS -->
    </main>

    <footer class="text-center text-slate-400 text-sm py-8 print:hidden">
        <p>Ace interactive CV generated for ${config.employerName}</p>
    </footer>

    <div id="privacy-modal" class="fixed inset-0 z-[100] bg-slate-950/70 p-4 md:p-6 flex items-center justify-center print:hidden" role="dialog" aria-modal="true" aria-labelledby="privacy-title">
        <div class="w-full max-w-3xl max-h-[90vh] overflow-y-auto rounded-2xl bg-white shadow-2xl border border-slate-200">
            <div class="p-5 md:p-8">
                <h2 id="privacy-title" class="text-xl md:text-2xl font-semibold text-slate-900 mb-2">Privacy Notice & Consent</h2>
                <p class="text-sm md:text-base text-slate-600 leading-relaxed mb-4">
                    This interactive CV can collect basic engagement analytics after you choose your preference. Your choice is saved only for this exported CV file session.
                </p>
                <div class="space-y-3 text-sm md:text-base text-slate-700 leading-relaxed">
                    <p><strong>Data categories:</strong> employer label, timestamp, time spent, maximum scroll percentage, and final granularity level.</p>
                    <p><strong>Purpose:</strong> understand whether this CV is being reviewed and at what level of detail to improve future applications.</p>
                    <p><strong>Retention:</strong> analytics records are stored in the configured Google Sheet until manually deleted by the CV owner.</p>
                    <p><strong>Legal basis / consent:</strong> analytics are processed only with your explicit consent by selecting <em>Accept & Continue</em>. Without consent, only strictly necessary on-page functionality remains enabled.</p>
                    <p><strong>Your rights:</strong> you may decline now, revisit your choice later, or request deletion/correction by contacting the CV owner directly.</p>
                    <p><strong>Contact path:</strong> use the contact details shown in the CV header (email/LinkedIn) to submit privacy requests.</p>
                    <p><strong>Analytics usage:</strong> no advertising profiling is performed; non-essential analytics are disabled if you decline.</p>
                </div>

                <div class="mt-6 flex flex-col sm:flex-row gap-3 sm:justify-end">
                    <button id="privacy-decline" class="w-full sm:w-auto px-4 py-2.5 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-100 focus:outline-none focus:ring-2 focus:ring-slate-400">Decline Analytics</button>
                    <button id="privacy-accept" class="w-full sm:w-auto px-4 py-2.5 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">Accept & Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Injection -->
    <script id="cv-data" type="application/json">${serializedData}<\/script>
    <script id="cv-config" type="application/json">${serializedConfig}<\/script>

    <!-- App Logic -->
    <script>
        (function() {
            const data = JSON.parse(document.getElementById('cv-data').textContent);
            const config = JSON.parse(document.getElementById('cv-config').textContent);
            
            const root = document.getElementById('cv-root');
            const slider = document.getElementById('granularity-slider');
            const levelNameLabel = document.getElementById('level-name');
            const privacyModal = document.getElementById('privacy-modal');
            const acceptBtn = document.getElementById('privacy-accept');
            const declineBtn = document.getElementById('privacy-decline');
            const CONSENT_KEY = 'cv-privacy-consent:${config.exportSessionId}';
            let consentStatus = localStorage.getItem(CONSENT_KEY);
            
            let startTime = Date.now();
            let maxScroll = 0;
            let currentLevel = parseInt(slider.value);

            function applyConsentUI() {
                const hasChoice = consentStatus === 'accepted' || consentStatus === 'declined';
                if (privacyModal) {
                    privacyModal.style.display = hasChoice ? 'none' : 'flex';
                }
                document.body.style.overflow = hasChoice ? '' : 'hidden';
            }

            function setConsent(status) {
                consentStatus = status;
                localStorage.setItem(CONSENT_KEY, status);
                applyConsentUI();
            }

            function isAnalyticsAllowed() {
                return consentStatus === 'accepted';
            }

            acceptBtn?.addEventListener('click', () => setConsent('accepted'));
            declineBtn?.addEventListener('click', () => setConsent('declined'));

            applyConsentUI();
            
            // Expose for the test button
            window.testAnalytics = function() {
                const payload = getAnalyticsPayload();
                const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'analytics_test_payload.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert('Analytics payload downloaded! Check the file to see what data is sent to your sheet.');
                
                sendAnalytics(true);
            };

            function getAnalyticsPayload() {
                const duration = Math.floor((Date.now() - startTime) / 1000);
                const scrollPercentage = Math.round((maxScroll / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
                
                return {
                    employer: config.employerName,
                    timestamp: new Date().toISOString(),
                    durationSeconds: duration,
                    maxScrollPercentage: scrollPercentage,
                    finalGranularity: currentLevel
                };
            }
            
            function render(level) {
                currentLevel = level;
                const activeConfig = config.levels.find(l => l.level === level) || config.levels[config.levels.length - 1];
                levelNameLabel.textContent = \`Level \${level}: \${activeConfig.name}\`;
                
                let html = '';

                // Header
                html += \`
                    <header class="mb-8 border-b border-slate-900 pb-8 text-center fade-in">
                        \${data.personalInfo.image ? \`<img src="\${data.personalInfo.image}" alt="Profile" class="w-32 h-32 rounded-full mx-auto mb-4 object-cover border-4 border-slate-100 shadow-md">\` : ''}
                        
                        <div class="flex items-center justify-center gap-3 flex-wrap mb-2">
                            <h1 class="text-3xl md:text-4xl font-serif font-bold text-slate-900">\${data.personalInfo.name}</h1>
                            \${data.personalInfo.pronouns ? \`<span class="text-sm text-slate-500 bg-slate-100 px-2 py-1 rounded-full sans">\${data.personalInfo.pronouns}</span>\` : ''}
                        </div>
                        
                        <p class="text-lg italic text-slate-600 mb-4 px-4">\${data.personalInfo.tagline}</p>
                        
                        <div class="flex flex-wrap justify-center gap-4 text-sm sans text-slate-500 px-4">
                            \${data.personalInfo.email ? \`<span>\${data.personalInfo.email}</span>\` : ''}
                            \${data.personalInfo.email && data.personalInfo.phone ? '<span>•</span>' : ''}
                            \${data.personalInfo.phone ? \`<span>\${data.personalInfo.phone}</span>\` : ''}
                            \${(data.personalInfo.email || data.personalInfo.phone) && data.personalInfo.location ? '<span>•</span>' : ''}
                            \${data.personalInfo.location ? \`<span>\${data.personalInfo.location}</span>\` : ''}
                        </div>

                        <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm sans font-medium text-blue-600 px-4">
                             \${data.personalInfo.linkedin ? \`<a href="\${data.personalInfo.linkedin}" target="_blank" class="hover:underline flex items-center gap-1"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg> LinkedIn</a>\` : ''}
                             \${data.personalInfo.github ? \`<a href="https://\${data.personalInfo.github}" target="_blank" class="hover:underline flex items-center gap-1"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg> GitHub</a>\` : ''}
                             \${data.personalInfo.calendly ? \`<a href="\${data.personalInfo.calendly}" target="_blank" class="hover:underline flex items-center gap-1"><svg width="14" height="14" fill="currentColor" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></svg> Book Meeting</a>\` : ''}
                        </div>
                    </header>
                \`;

                const itemsToShow = data.items.filter(item => item.granularity.includes(level));
                
                // Use custom section order
                const sectionOrder = data.sectionOrder;
                
                const grouped = itemsToShow.reduce((acc, item) => {
                    if (!acc[item.section]) acc[item.section] = [];
                    acc[item.section].push(item);
                    return acc;
                }, {});

                sectionOrder.forEach(section => {
                    if (grouped[section] && grouped[section].length > 0) {
                        html += \`
                            <section class="mb-8 fade-in" data-section="\${section}">
                                <h2 class="text-xl font-bold uppercase tracking-widest border-b-2 border-slate-900 mb-4 pb-1">\${section}</h2>
                                <div class="space-y-6">
                        \`;
                        
                        grouped[section].forEach(item => {
                            html += \`
                                <div class="group break-inside-avoid">
                                    <div class="flex flex-col md:flex-row md:justify-between md:items-baseline mb-1">
                                        <h3 class="text-lg font-bold text-slate-800">\${item.title}</h3>
                                        \${item.date ? \`<span class="text-sm font-mono text-slate-500 shrink-0">\${item.date}</span>\` : ''}
                                    </div>
                                    \${item.subtitle ? \`<div class="text-md italic text-slate-700 mb-1">\${item.subtitle}</div>\` : ''}
                                    \${item.location ? \`<div class="text-xs text-slate-400 mb-2">\${item.location}</div>\` : ''}
                                    <div class="text-sm leading-relaxed text-slate-600 prose prose-sm max-w-none">
                                        \${item.content}
                                    </div>
                                </div>
                            \`;
                        });

                        html += \`</div></section>\`;
                    }
                });

                root.innerHTML = html;
            }

            slider.addEventListener('input', (e) => {
                render(parseInt(e.target.value));
            });

            function sendAnalytics(isTest = false) {
                if (!config.googleSheetUrl) {
                    if(isTest) alert("No Google Sheet URL configured.");
                    return;
                }

                if (!isAnalyticsAllowed()) {
                    if (isTest) {
                        alert('Analytics transmission is disabled because consent was declined or not yet provided.');
                    }
                    return;
                }
                
                const payload = getAnalyticsPayload();

                fetch(config.googleSheetUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                })
                .then(() => { if(isTest) alert("Data sent to Google Sheets (no-cors mode). Check your sheet."); })
                .catch(err => { if(isTest) alert("Error sending: " + err); });
            }

            window.addEventListener('scroll', () => {
                const currentScroll = window.scrollY;
                if (currentScroll > maxScroll) maxScroll = currentScroll;
            });

            setInterval(() => sendAnalytics(false), 15000); 
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') sendAnalytics(false);
            });

            render(config.defaultLevel);

        })();
    <\/script>
</body>
</html>`;
        };

        // --- INDEXEDDB LAYER ---
        const cvStorage = (() => {
            const DB_NAME = 'granular-cv-builder';
            const DB_VERSION = 1;

            const openDB = () => new Promise<IDBDatabase>((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    if (!db.objectStoreNames.contains('cvs')) {
                        db.createObjectStore('cvs', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('versions')) {
                        const store = db.createObjectStore('versions', { keyPath: 'id' });
                        store.createIndex('by_cvId', 'cvId', { unique: false });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });

            const runTransaction = async (storeName, mode, operation) => {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction(storeName, mode);
                    const store = tx.objectStore(storeName);
                    const request = operation(store);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            };

            return {
                getAllCvs: async (): Promise<CVRecord[]> => {
                    const records = await runTransaction('cvs', 'readonly', store => store.getAll()) as CVRecord[];
                    return records.sort((a, b) => b.updatedAt - a.updatedAt);
                },
                getCv: async (id: string): Promise<CVRecord | undefined> => runTransaction('cvs', 'readonly', store => store.get(id)) as Promise<CVRecord | undefined>,
                putCv: async (record: CVRecord): Promise<void> => {
                    await runTransaction('cvs', 'readwrite', store => store.put(record));
                },
                deleteCv: async (id: string): Promise<void> => {
                    await runTransaction('cvs', 'readwrite', store => store.delete(id));
                    const db = await openDB();
                    await new Promise((resolve, reject) => {
                        const tx = db.transaction('versions', 'readwrite');
                        const index = tx.objectStore('versions').index('by_cvId');
                        const cursorRequest = index.openCursor(IDBKeyRange.only(id));
                        cursorRequest.onsuccess = () => {
                            const cursor = cursorRequest.result;
                            if (cursor) {
                                cursor.delete();
                                cursor.continue();
                            } else {
                                resolve(true);
                            }
                        };
                        cursorRequest.onerror = () => reject(cursorRequest.error);
                    });
                },
                addVersion: async (version: CVVersion): Promise<void> => {
                    await runTransaction('versions', 'readwrite', store => store.put(version));
                },
                getVersionsForCv: async (cvId: string): Promise<CVVersion[]> => {
                    const db = await openDB();
                    return new Promise((resolve, reject) => {
                        const tx = db.transaction('versions', 'readonly');
                        const index = tx.objectStore('versions').index('by_cvId');
                        const request = index.getAll(cvId);
                        request.onsuccess = () => {
                            const versions = (request.result as CVVersion[]) || [];
                            resolve(versions.sort((a, b) => b.createdAt - a.createdAt));
                        };
                        request.onerror = () => reject(request.error);
                    });
                }
            };
        })();

        // --- COMPONENTS ---
        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        };

        const App = () => {
            const [activeCvId, setActiveCvId] = useState('default-cv');
            const [cvList, setCvList] = useState<CVRecord[]>([]);
            const [versionTimeline, setVersionTimeline] = useState<CVVersion[]>([]);
            const [cvData, setCvData] = useState(INITIAL_CV_DATA);
            const [levels, setLevels] = useState(DEFAULT_LEVELS);
            const [activeTab, setActiveTab] = useState('content');
            const [isDbReady, setIsDbReady] = useState(false);
            
            // Generation Config State
            const [employerName, setEmployerName] = useState('');
            const [sheetUrl, setSheetUrl] = useState('');
            const [defaultLevel, setDefaultLevel] = useState(5);
            const [includeTestButton, setIncludeTestButton] = useState(true);
            const [exportSessionId] = useState(() => {
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    return crypto.randomUUID();
                }
                return `session-${Date.now()}-${Math.floor(Math.random() * 1e6)}`;
            });

            // PDF Import State
            const fileInputRef = useRef(null);
            const [isImporting, setIsImporting] = useState(false);
            
            // Section Management State
            const [newSectionName, setNewSectionName] = useState('');
            const autosaveTimerRef = useRef(null);
            const versionTimerRef = useRef(null);
            const isHydratingRef = useRef(true);
            const previousCvDataRef = useRef(INITIAL_CV_DATA);

            const currentCvName = cvList.find(cv => cv.id === activeCvId)?.name || 'Untitled CV';

            const isMajorEdit = (nextData: CVData, prevData: CVData) => {
                const itemCountChanged = nextData.items.length !== prevData.items.length;
                const sectionCountChanged = nextData.sectionOrder.length !== prevData.sectionOrder.length;
                const profileShift = Math.abs((nextData.personalInfo.tagline || '').length - (prevData.personalInfo.tagline || '').length) > 30;
                const bodyShift = Math.abs(nextData.items.reduce((sum, item) => sum + (item.content?.length || 0), 0) - prevData.items.reduce((sum, item) => sum + (item.content?.length || 0), 0)) > 200;
                return itemCountChanged || sectionCountChanged || profileShift || bodyShift;
            };

            useEffect(() => {
                const bootstrap = async () => {
                    try {
                        const existing = await cvStorage.getAllCvs();
                        if (!existing.length) {
                            const starterRecord: CVRecord = {
                                id: 'default-cv',
                                name: 'Primary CV',
                                createdAt: Date.now(),
                                updatedAt: Date.now(),
                                data: INITIAL_CV_DATA
                            };
                            await cvStorage.putCv(starterRecord);
                            setCvList([starterRecord]);
                            setActiveCvId(starterRecord.id);
                            setCvData(starterRecord.data);
                            previousCvDataRef.current = starterRecord.data;
                        } else {
                            setCvList(existing);
                            setActiveCvId(existing[0].id);
                            setCvData(existing[0].data);
                            previousCvDataRef.current = existing[0].data;
                        }
                    } catch (error) {
                        console.error('Failed to initialize IndexedDB', error);
                    } finally {
                        setIsDbReady(true);
                        setTimeout(() => {
                    isHydratingRef.current = false;
                }, 0);
                    }
                };
                bootstrap();
            }, []);

            useEffect(() => {
                if (!isDbReady || !activeCvId) return;
                const loadVersions = async () => {
                    const versions = await cvStorage.getVersionsForCv(activeCvId);
                    setVersionTimeline(versions);
                };
                loadVersions();
            }, [activeCvId, isDbReady]);

            useEffect(() => {
                if (!isDbReady || !activeCvId || isHydratingRef.current) return;
                if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current);
                autosaveTimerRef.current = setTimeout(async () => {
                    const now = Date.now();
                    const existingRecord = cvList.find(cv => cv.id === activeCvId);
                    const updatedRecord: CVRecord = {
                        id: activeCvId,
                        name: existingRecord?.name || cvData.personalInfo.name || 'Untitled CV',
                        createdAt: existingRecord?.createdAt || now,
                        updatedAt: now,
                        data: cvData
                    };
                    await cvStorage.putCv(updatedRecord);
                    setCvList(prev => [updatedRecord, ...prev.filter(cv => cv.id !== activeCvId)].sort((a, b) => b.updatedAt - a.updatedAt));
                }, 500);

                return () => {
                    if (autosaveTimerRef.current) clearTimeout(autosaveTimerRef.current);
                };
            }, [cvData, activeCvId, isDbReady]);

            useEffect(() => {
                if (!isDbReady || !activeCvId || isHydratingRef.current) return;
                const previousData = previousCvDataRef.current;
                if (!isMajorEdit(cvData, previousData)) {
                    previousCvDataRef.current = cvData;
                    return;
                }

                if (versionTimerRef.current) clearTimeout(versionTimerRef.current);
                versionTimerRef.current = setTimeout(async () => {
                    const version: CVVersion = {
                        id: `version-${activeCvId}-${Date.now()}`,
                        cvId: activeCvId,
                        createdAt: Date.now(),
                        label: `Major edit - ${new Date().toLocaleString()}`,
                        data: cvData
                    };
                    await cvStorage.addVersion(version);
                    setVersionTimeline(prev => [version, ...prev]);
                    previousCvDataRef.current = cvData;
                }, 1200);
            }, [cvData, activeCvId, isDbReady]);



            const handleCreateCv = async () => {
                const name = prompt('Name for the new CV:', `CV ${cvList.length + 1}`)?.trim();
                if (!name) return;
                const id = `cv-${Date.now()}`;
                const record: CVRecord = {
                    id,
                    name,
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    data: JSON.parse(JSON.stringify(INITIAL_CV_DATA))
                };
                await cvStorage.putCv(record);
                setCvList(prev => [record, ...prev]);
                isHydratingRef.current = true;
                setActiveCvId(id);
                setCvData(record.data);
                previousCvDataRef.current = record.data;
                setTimeout(() => {
                    isHydratingRef.current = false;
                }, 0);
            };

            const handleDuplicateCv = async () => {
                const source = cvList.find(cv => cv.id === activeCvId);
                if (!source) return;
                const id = `cv-${Date.now()}`;
                const record: CVRecord = {
                    id,
                    name: `${source.name} (Copy)`,
                    createdAt: Date.now(),
                    updatedAt: Date.now(),
                    data: JSON.parse(JSON.stringify(source.data))
                };
                await cvStorage.putCv(record);
                setCvList(prev => [record, ...prev]);
                isHydratingRef.current = true;
                setActiveCvId(id);
                setCvData(record.data);
                previousCvDataRef.current = record.data;
                setTimeout(() => {
                    isHydratingRef.current = false;
                }, 0);
            };

            const handleRenameCv = async () => {
                const current = cvList.find(cv => cv.id === activeCvId);
                if (!current) return;
                const name = prompt('Rename CV:', current.name)?.trim();
                if (!name || name === current.name) return;
                const renamed = { ...current, name, updatedAt: Date.now() };
                await cvStorage.putCv(renamed);
                setCvList(prev => prev.map(cv => cv.id === activeCvId ? renamed : cv).sort((a, b) => b.updatedAt - a.updatedAt));
            };

            const handleDeleteCv = async () => {
                if (cvList.length <= 1) {
                    alert('At least one CV must remain.');
                    return;
                }
                const current = cvList.find(cv => cv.id === activeCvId);
                if (!current) return;
                if (!confirm(`Delete "${current.name}" and all saved versions?`)) return;
                await cvStorage.deleteCv(activeCvId);
                const remaining = cvList.filter(cv => cv.id !== activeCvId);
                const fallback = remaining[0];
                setCvList(remaining);
                if (fallback) {
                    isHydratingRef.current = true;
                    setActiveCvId(fallback.id);
                    setCvData(fallback.data);
                    previousCvDataRef.current = fallback.data;
                    setTimeout(() => {
                        isHydratingRef.current = false;
                    }, 0);
                }
            };

            const handleSwitchCv = async (id: string) => {
                if (id === activeCvId) return;
                const next = cvList.find(cv => cv.id === id);
                if (!next) return;
                isHydratingRef.current = true;
                setActiveCvId(id);
                setCvData(next.data);
                previousCvDataRef.current = next.data;
                setTimeout(() => {
                    isHydratingRef.current = false;
                }, 0);
            };

            const handleRestoreVersion = async (version: CVVersion) => {
                if (!confirm(`Restore version from ${new Date(version.createdAt).toLocaleString()}?`)) return;
                isHydratingRef.current = true;
                setCvData(version.data);
                previousCvDataRef.current = version.data;
                const current = cvList.find(cv => cv.id === activeCvId);
                if (current) {
                    const updated = { ...current, data: version.data, updatedAt: Date.now() };
                    await cvStorage.putCv(updated);
                    setCvList(prev => prev.map(cv => cv.id === activeCvId ? updated : cv).sort((a, b) => b.updatedAt - a.updatedAt));
                }
                setTimeout(() => {
                    isHydratingRef.current = false;
                }, 0);
            };

            // --- Handlers ---

            const handleLevelToggle = (itemId, level) => {
                setCvData(prev => ({
                    ...prev,
                    items: prev.items.map(item => {
                        if (item.id !== itemId) return item;
                        const newLevels = item.granularity.includes(level)
                        ? item.granularity.filter(l => l !== level)
                        : [...item.granularity, level].sort((a, b) => a - b);
                        return { ...item, granularity: newLevels };
                    })
                }));
            };

            const handleAddItem = () => {
                const newItem: CVItem = {
                    id: 'new-' + Date.now(),
                    section: cvData.sectionOrder[0] || 'Experience',
                    title: 'New Position',
                    content: 'Description here...',
                    granularity: [5, 6, 7, 8, 9, 10]
                };
                setCvData(prev => ({ ...prev, items: [newItem, ...prev.items] }));
            };

            const handleDeleteItem = (id) => {
                if(confirm('Are you sure you want to delete this item?')) {
                    setCvData(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleMoveItem = (index, direction) => {
                const newItems = [...cvData.items];
                if (direction === -1 && index > 0) {
                    [newItems[index], newItems[index - 1]] = [newItems[index - 1], newItems[index]];
                } else if (direction === 1 && index < newItems.length - 1) {
                    [newItems[index], newItems[index + 1]] = [newItems[index + 1], newItems[index]];
                }
                setCvData(prev => ({ ...prev, items: newItems }));
            };

            const handleImportPDF = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                setIsImporting(true);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        fullText += pageText + "\n";
                    }

                    const newItems = [];
                    
                    // Basic heuristic: check if we have an "Imported" section, if not add it
                    if(!cvData.sectionOrder.includes('Imported')) {
                        setCvData(prev => ({...prev, sectionOrder: [...prev.sectionOrder, 'Imported']}));
                    }

                    newItems.push({
                        id: 'import-' + Date.now(),
                        section: 'Imported',
                        title: 'Imported PDF Content',
                        subtitle: 'Please manually separate this into items',
                        content: fullText,
                        granularity: [1,2,3,4,5,6,7,8,9,10]
                    });
                    
                    setCvData(prev => ({
                        ...prev,
                        items: [...prev.items, ...newItems]
                    }));
                    
                    alert('PDF Imported! Content added to the bottom of the list. Please refine.');

                } catch (err) {
                    console.error(err);
                    alert("Failed to parse PDF. Make sure it is a valid PDF.");
                } finally {
                    setIsImporting(false);
                    if(fileInputRef.current) fileInputRef.current.value = '';
                }
            };
            
            const handleImageChange = (e) => {
                const file = e.target.files?.[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setCvData(prev => ({...prev, personalInfo: {...prev.personalInfo, image: reader.result}}));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleAddSection = () => {
                if(newSectionName && !cvData.sectionOrder.includes(newSectionName)) {
                    setCvData(prev => ({...prev, sectionOrder: [...prev.sectionOrder, newSectionName]}));
                    setNewSectionName('');
                }
            };

            const handleDeleteSection = (section) => {
                if(confirm(`Delete section "${section}"? Items in this section will NOT be deleted, but you should reassign them.`)) {
                    setCvData(prev => ({...prev, sectionOrder: prev.sectionOrder.filter(s => s !== section)}));
                }
            };

            const handleMoveSection = (index, direction) => {
                const newOrder = [...cvData.sectionOrder];
                if (direction === -1 && index > 0) {
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
                } else if (direction === 1 && index < newOrder.length - 1) {
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                }
                setCvData(prev => ({...prev, sectionOrder: newOrder}));
            };

            const handleDownload = () => {
                if (!employerName) {
                    alert("Please enter an employer name for tracking.");
                    return;
                }
                
                const config = {
                    employerName,
                    googleSheetUrl: sheetUrl,
                    defaultLevel,
                    levels,
                    includeTestButton,
                    exportSessionId
                };

                const htmlContent = generateCVHTML(cvData, config);
                const blobHtml = new Blob([htmlContent], { type: 'text/html' });
                const urlHtml = URL.createObjectURL(blobHtml);
                const aHtml = document.createElement('a');
                aHtml.href = urlHtml;
                aHtml.download = `${employerName.replace(/\s+/g, '_')}_Ace_CV.html`;
                document.body.appendChild(aHtml);
                aHtml.click();
                document.body.removeChild(aHtml);
                URL.revokeObjectURL(urlHtml);

                setTimeout(() => {
                    const blobMd = new Blob([ANALYTICS_GUIDE_MD], { type: 'text/markdown' });
                    const urlMd = URL.createObjectURL(blobMd);
                    const aMd = document.createElement('a');
                    aMd.href = urlMd;
                    aMd.download = 'README_ANALYTICS.md';
                    document.body.appendChild(aMd);
                    aMd.click();
                    document.body.removeChild(aMd);
                    URL.revokeObjectURL(urlMd);
                }, 500);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col font-sans pb-12 sm:pb-0">
                {/* Navbar */}
                <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-20">
                    <div className="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2">
                            <span className="text-xl font-bold tracking-tight">Ace</span>
                            <span className="bg-blue-600 text-xs px-2 py-0.5 rounded-full">Builder</span>
                        </div>
                        <div className="flex overflow-x-auto gap-2 w-full sm:w-auto pb-1 sm:pb-0 no-scrollbar">
                            <button 
                                onClick={() => setActiveTab('content')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'content' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.Edit /> Content
                            </button>
                            <button 
                                onClick={() => setActiveTab('sections')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'sections' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.List /> Sections
                            </button>
                            <button 
                                onClick={() => setActiveTab('granularity')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'granularity' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.Settings /> Granularity
                            </button>
                            <button 
                                onClick={() => setActiveTab('generate')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'generate' ? 'bg-green-700 hover:bg-green-600' : 'bg-slate-700 hover:bg-slate-800'}`}
                            >
                                <Icons.Download /> Generate
                            </button>
                        </div>
                    </div>
                </nav>

                {/* Main Content */}
                <main className="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6">
                    
                    {/* TAB: CONTENT EDITOR */}
                    {activeTab === 'content' && (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 space-y-4">
                            <div className="flex flex-col lg:flex-row lg:items-center gap-3 lg:justify-between">
                                <div>
                                    <h2 className="text-lg font-bold text-slate-800">CV Workspace</h2>
                                    <p className="text-sm text-slate-500">Editing: <span className="font-semibold text-slate-700">{currentCvName}</span></p>
                                </div>
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={handleCreateCv} className="text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">New</button>
                                    <button onClick={handleDuplicateCv} className="text-sm bg-slate-100 text-slate-700 px-3 py-2 rounded border border-slate-300 hover:bg-slate-200">Duplicate</button>
                                    <button onClick={handleRenameCv} className="text-sm bg-slate-100 text-slate-700 px-3 py-2 rounded border border-slate-300 hover:bg-slate-200">Rename</button>
                                    <button onClick={handleDeleteCv} className="text-sm bg-red-50 text-red-700 px-3 py-2 rounded border border-red-200 hover:bg-red-100">Delete</button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1 block">Switch CV</label>
                                    <select value={activeCvId} onChange={(e) => handleSwitchCv(e.target.value)} className="w-full p-2 border border-gray-300 rounded outline-none focus:border-blue-500">
                                        {cvList.map(cv => (
                                            <option key={cv.id} value={cv.id}>{cv.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="text-xs font-semibold uppercase tracking-wider text-slate-500 mb-1 block">Version Timeline</label>
                                    <div className="max-h-32 overflow-y-auto border border-slate-200 rounded p-2 bg-slate-50 space-y-1">
                                        {versionTimeline.length === 0 && <p className="text-xs text-slate-500">No major edits captured yet.</p>}
                                        {versionTimeline.map(version => (
                                            <button key={version.id} onClick={() => handleRestoreVersion(version)} className="w-full text-left text-xs p-2 bg-white border border-slate-200 rounded hover:border-blue-300 hover:bg-blue-50">
                                                <div className="font-semibold text-slate-700">{version.label}</div>
                                                <div className="text-slate-500">{new Date(version.createdAt).toLocaleString()}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 className="text-lg font-bold text-slate-800 mb-4">Personal Info</h2>
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="flex flex-col items-center gap-3">
                                <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-slate-100 bg-slate-100 relative group">
                                    <img src={cvData.personalInfo.image || 'https://via.placeholder.com/150'} className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <span className="text-white text-xs font-bold">Change</span>
                                    </div>
                                    <input type="file" accept="image/*" onChange={handleImageChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                                <span className="text-xs text-slate-400">Tap to upload</span>
                            </div>
                            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.name} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, name: e.target.value}})}
                                placeholder="Full Name"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.pronouns} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, pronouns: e.target.value}})}
                                placeholder="Pronouns (e.g. he/him)"
                                />
                                <input 
                                className="border p-2 rounded md:col-span-2" 
                                value={cvData.personalInfo.tagline} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, tagline: e.target.value}})}
                                placeholder="Tagline / Headline"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.calendly} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, calendly: e.target.value}})}
                                placeholder="Calendly Link (Optional)"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.linkedin} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, linkedin: e.target.value}})}
                                placeholder="LinkedIn URL"
                                />
                            </div>
                        </div>
                        </div>

                        <div className="space-y-4">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200 gap-4">
                            <h2 className="text-lg font-bold text-slate-800">CV Items</h2>
                            <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                                <button 
                                    onClick={handleAddItem}
                                    className="flex-1 sm:flex-none text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex items-center justify-center gap-2 font-medium"
                                >
                                    <Icons.Plus /> Add Item
                                </button>
                                <div className="flex-1 sm:flex-none relative overflow-hidden">
                                    <button className="w-full text-sm bg-slate-100 text-slate-700 px-3 py-2 rounded hover:bg-slate-200 border border-slate-300 flex items-center justify-center gap-2">
                                        {isImporting ? 'Parsing...' : 'Import PDF'}
                                    </button>
                                    <input 
                                        type="file" 
                                        accept=".pdf" 
                                        ref={fileInputRef}
                                        onChange={handleImportPDF}
                                        className="absolute inset-0 opacity-0 cursor-pointer"
                                        disabled={isImporting}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {cvData.items.map((item, idx) => (
                            <div key={item.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-300 transition-colors relative group">
                            
                            {/* Controls */}
                            <div className="absolute top-4 right-4 flex items-center gap-2 z-10">
                                <button onClick={() => handleMoveItem(idx, -1)} disabled={idx === 0} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowUp /></button>
                                <button onClick={() => handleMoveItem(idx, 1)} disabled={idx === cvData.items.length - 1} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowDown /></button>
                                <button onClick={() => handleDeleteItem(item.id)} className="p-1 text-slate-400 hover:text-red-600"><Icons.Trash /></button>
                            </div>

                            <div className="flex justify-between items-start mb-4">
                                <div className="flex-1 mr-0 sm:mr-12">
                                <div className="flex gap-2 mb-2">
                                    <select 
                                        value={item.section}
                                        onChange={(e) => {
                                            const newItems = [...cvData.items];
                                            newItems[idx].section = e.target.value;
                                            setCvData({...cvData, items: newItems});
                                        }}
                                        className="text-xs font-bold uppercase text-slate-500 tracking-wider bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none max-w-full"
                                    >
                                        {cvData.sectionOrder.map(s => <option key={s} value={s}>{s}</option>)}
                                        {!cvData.sectionOrder.includes('Imported') && <option value="Imported">Imported</option>}
                                    </select>
                                </div>
                                <input 
                                    value={item.title} 
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].title = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Title"
                                    className="text-lg font-bold text-slate-900 w-full border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none transition-colors mb-1"
                                />
                                <input 
                                    value={item.subtitle || ''} 
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].subtitle = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Subtitle"
                                    className="text-sm font-medium text-slate-600 w-full border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none transition-colors mb-2"
                                />
                                <textarea
                                    value={item.content}
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].content = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Description / Content..."
                                    className="w-full text-sm text-slate-600 mt-2 p-2 border border-transparent hover:border-gray-200 focus:border-blue-200 rounded outline-none h-24 resize-y bg-slate-50"
                                />
                                </div>
                            </div>

                            {/* Granularity Toggles */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <p className="text-xs font-semibold text-slate-400 mb-2 uppercase flex items-center gap-2">
                                    Visible at Levels:
                                    <span className="text-[10px] font-normal text-slate-400 normal-case">(Click to toggle)</span>
                                </p>
                                <div className="flex flex-wrap gap-1">
                                {levels.map((lvl) => (
                                    <button
                                    key={lvl.level}
                                    onClick={() => handleLevelToggle(item.id, lvl.level)}
                                    className={`w-8 h-8 rounded-full text-xs font-medium flex items-center justify-center transition-all ${
                                        item.granularity.includes(lvl.level)
                                        ? 'bg-blue-600 text-white shadow-md scale-105'
                                        : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                                    }`}
                                    title={lvl.name}
                                    >
                                    {lvl.level}
                                    </button>
                                ))}
                                </div>
                            </div>
                            </div>
                        ))}
                        </div>
                    </div>
                    )}
                    
                    {/* TAB: SECTIONS MANAGER */}
                    {activeTab === 'sections' && (
                        <div className="max-w-3xl mx-auto space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h2 className="text-xl font-bold text-slate-900 mb-2">Manage Sections</h2>
                                <p className="text-slate-500 mb-6 text-sm">Add, remove, or reorder sections. The order here determines the order in the final CV.</p>
                                
                                <div className="flex gap-2 mb-6">
                                    <input 
                                        value={newSectionName}
                                        onChange={(e) => setNewSectionName(e.target.value)}
                                        placeholder="New Section Name (e.g. References)"
                                        className="flex-1 p-2 border border-gray-300 rounded outline-none focus:border-blue-500"
                                    />
                                    <button 
                                        onClick={handleAddSection}
                                        disabled={!newSectionName}
                                        className="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        Add
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {cvData.sectionOrder.map((section, idx) => (
                                        <div key={section} className="flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded group">
                                            <span className="font-medium text-slate-700">{section}</span>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleMoveSection(idx, -1)} disabled={idx === 0} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowUp /></button>
                                                <button onClick={() => handleMoveSection(idx, 1)} disabled={idx === cvData.sectionOrder.length - 1} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowDown /></button>
                                                <button onClick={() => handleDeleteSection(section)} className="p-1 text-slate-400 hover:text-red-600"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TAB: GRANULARITY SETTINGS */}
                    {activeTab === 'granularity' && (
                    <div className="max-w-3xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-900 mb-6">Granularity Levels</h2>
                        <p className="text-slate-500 mb-8">Define the name and purpose of each detail level. This matches the UI shown in the generated CV.</p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {levels.map((lvl, idx) => (
                            <div key={lvl.level} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold">
                                {lvl.level}
                                </div>
                                <input 
                                value={lvl.name}
                                onChange={(e) => {
                                    const newLevels = [...levels];
                                    newLevels[idx].name = e.target.value;
                                    setLevels(newLevels);
                                }}
                                className="font-bold text-slate-800 border-b border-transparent focus:border-blue-500 outline-none w-full"
                                />
                            </div>
                            <input 
                                value={lvl.description}
                                onChange={(e) => {
                                const newLevels = [...levels];
                                newLevels[idx].description = e.target.value;
                                setLevels(newLevels);
                                }}
                                className="w-full text-sm text-slate-500 border border-transparent hover:border-gray-200 p-1 rounded"
                            />
                            </div>
                        ))}
                        </div>
                    </div>
                    )}

                    {/* TAB: GENERATE */}
                    {activeTab === 'generate' && (
                    <div className="max-w-2xl mx-auto mt-4 sm:mt-12">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-8 text-white">
                            <h2 className="text-3xl font-bold mb-2">Export CV</h2>
                            <p className="text-slate-300">Generate a unique, tracked HTML file for a specific employer.</p>
                        </div>
                        
                        <div className="p-8 space-y-6">
                            <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Employer / Recipient Name</label>
                            <input 
                                type="text" 
                                value={employerName}
                                onChange={(e) => setEmployerName(e.target.value)}
                                placeholder="e.g. Acme Corp, Hiring Manager"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                            <p className="text-xs text-slate-500 mt-1">This name will be logged in analytics and shown in the footer.</p>
                            </div>

                            <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Google Sheet Web App URL (Optional)</label>
                            <input 
                                type="text" 
                                value={sheetUrl}
                                onChange={(e) => setSheetUrl(e.target.value)}
                                placeholder="https://script.google.com/macros/s/..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                            />
                            <p className="text-xs text-slate-500 mt-1">Deploy a Google Apps Script to receive POST requests with JSON payloads.</p>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">Default Granularity Level</label>
                                <div className="flex items-center gap-4">
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="10" 
                                        value={defaultLevel} 
                                        onChange={(e) => setDefaultLevel(parseInt(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                    <span className="font-bold text-blue-600 w-8">{defaultLevel}</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-3 py-2">
                                <input 
                                    type="checkbox" 
                                    id="testBtn"
                                    checked={includeTestButton}
                                    onChange={(e) => setIncludeTestButton(e.target.checked)}
                                    className="w-4 h-4 text-blue-600 rounded"
                                />
                                <label htmlFor="testBtn" className="text-sm text-slate-700">Include "Test Analytics" button in generated CV?</label>
                            </div>

                            <div className="pt-4 border-t border-gray-100">
                            <button 
                                onClick={handleDownload}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform transform active:scale-95 flex items-center justify-center gap-2"
                            >
                                <Icons.Download /> Download Single-File HTML & Guide
                            </button>
                            </div>
                        </div>
                        </div>
                    </div>
                    )}
                </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
