<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Granular CV Builder</title>
    <meta name="description" content="Generate interactive CVs" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better mobile feel in preview areas */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- TYPES ---
        // We now treat SectionType as string to allow dynamic sections
        type SectionType = string;

        interface CVItem {
            id: string;
            section: SectionType;
            title: string;
            subtitle?: string;
            date?: string;
            location?: string;
            content: string;
            links?: { label: string; url: string }[];
            granularity: number[];
        }

        interface GranularityLevel {
            level: number;
            name: string;
            description: string;
        }

        interface CVData {
            personalInfo: {
                name: string;
                pronouns: string;
                tagline: string;
                email: string;
                phone: string;
                location: string;
                linkedin: string;
                github: string;
                website: string;
                calendly: string;
                image: string; // Base64 or URL
            };
            sectionOrder: string[];
            items: CVItem[];
        }

        interface ThemeOption {
            id: string;
            name: string;
            description: string;
            primary: string;
            accent: string;
            text: string;
            muted: string;
            background: string;
        }

        interface SpacingOption {
            id: string;
            name: string;
            container: string;
            sectionGap: string;
            itemGap: string;
        }

        interface BackgroundOption {
            id: string;
            name: string;
            bodyClass: string;
            cardClass: string;
        }

        interface LayoutPreset {
            id: string;
            name: string;
            description: string;
            containerClass: string;
            headerClass: string;
            sectionClass: string;
            sectionTitleClass: string;
            itemClass: string;
            isTimeline?: boolean;
            isSidebar?: boolean;
        }

        interface GeneratorConfig {
            employerName: string;
            googleSheetUrl: string;
            defaultLevel: number;
            levels: GranularityLevel[];
            includeTestButton: boolean;
            layoutPreset: string;
            colorPalette: string;
            spacing: string;
            backgroundStyle: string;
        }

        // --- CONSTANTS ---
        const DEFAULT_LEVELS: GranularityLevel[] = [
            { level: 1, name: 'Pitch', description: 'The elevator pitch' },
            { level: 2, name: 'Education', description: 'Academic background' },
            { level: 3, name: 'Experience', description: 'Key professional roles' },
            { level: 4, name: 'Policy & Advocacy', description: 'Specific policy work' },
            { level: 5, name: 'Projects', description: 'Key deliverables' },
            { level: 6, name: 'Writings', description: 'Publications and research' },
            { level: 7, name: 'Honors', description: 'Awards and recognition' },
            { level: 8, name: 'Service', description: 'Volunteering and organizations' },
            { level: 9, name: 'Learning', description: 'Courses and conferences' },
            { level: 10, name: 'Complete CV', description: 'Everything' },
        ];

        const DEFAULT_SECTIONS = [
            'Profile', 'Education', 'Experience', 'Projects', 'Writings', 
            'Awards', 'Certificates', 'Organisations', 'Skills', 'Interests', 'References'
        ];


        const LAYOUT_PRESETS: LayoutPreset[] = [
            { id: 'classic', name: 'Classic', description: 'Traditional single-column resume.', containerClass: 'max-w-4xl mx-auto', headerClass: 'text-center border-b border-slate-900 pb-8 mb-8', sectionClass: 'mb-8', sectionTitleClass: 'text-xl font-bold uppercase tracking-widest border-b-2 border-slate-900 mb-4 pb-1', itemClass: 'mb-5' },
            { id: 'modern', name: 'Modern', description: 'Clean cards and lighter dividers.', containerClass: 'max-w-5xl mx-auto', headerClass: 'rounded-2xl p-8 mb-6 shadow-sm border', sectionClass: 'mb-6 rounded-xl border p-5 shadow-sm', sectionTitleClass: 'text-lg font-semibold tracking-wide mb-4', itemClass: 'mb-4 last:mb-0' },
            { id: 'compact', name: 'Compact', description: 'Dense spacing for concise CVs.', containerClass: 'max-w-3xl mx-auto', headerClass: 'border-b pb-4 mb-4', sectionClass: 'mb-4', sectionTitleClass: 'text-base font-bold uppercase mb-2', itemClass: 'mb-3 text-sm' },
            { id: 'sidebar', name: 'Sidebar', description: 'Two-column profile + content.', containerClass: 'max-w-6xl mx-auto md:grid md:grid-cols-3 md:gap-8', headerClass: 'md:col-span-1 md:sticky md:top-24 md:self-start border rounded-xl p-5 mb-6', sectionClass: 'md:col-span-2 mb-6', sectionTitleClass: 'text-lg font-bold border-b pb-2 mb-3', itemClass: 'mb-4' , isSidebar: true},
            { id: 'timeline', name: 'Timeline', description: 'Role history with chronological rail.', containerClass: 'max-w-4xl mx-auto', headerClass: 'text-center mb-8', sectionClass: 'mb-8', sectionTitleClass: 'text-xl font-bold mb-4', itemClass: 'mb-6 pl-6 border-l-2 relative', isTimeline: true },
            { id: 'ats', name: 'ATS-Friendly', description: 'Minimal visual styling for parsers.', containerClass: 'max-w-4xl mx-auto', headerClass: 'border-b pb-4 mb-6', sectionClass: 'mb-5', sectionTitleClass: 'text-lg font-bold uppercase mb-2', itemClass: 'mb-3' }
        ];

        const COLOR_PALETTES: ThemeOption[] = [
            { id: 'slate', name: 'Slate Blue', description: 'Balanced default', primary: '#0f172a', accent: '#2563eb', text: '#1e293b', muted: '#64748b', background: '#f8fafc' },
            { id: 'emerald', name: 'Emerald', description: 'Fresh and calm', primary: '#064e3b', accent: '#059669', text: '#134e4a', muted: '#6b7280', background: '#f0fdf4' },
            { id: 'violet', name: 'Violet', description: 'Creative and modern', primary: '#4c1d95', accent: '#7c3aed', text: '#312e81', muted: '#6b7280', background: '#f5f3ff' },
            { id: 'charcoal', name: 'Charcoal', description: 'ATS-safe monochrome', primary: '#111827', accent: '#374151', text: '#111827', muted: '#4b5563', background: '#ffffff' }
        ];

        const SPACING_PRESETS: SpacingOption[] = [
            { id: 'comfortable', name: 'Comfortable', container: 'p-6 md:p-12', sectionGap: 'space-y-7', itemGap: 'space-y-5' },
            { id: 'airy', name: 'Airy', container: 'p-8 md:p-14', sectionGap: 'space-y-9', itemGap: 'space-y-6' },
            { id: 'compact', name: 'Compact', container: 'p-4 md:p-8', sectionGap: 'space-y-4', itemGap: 'space-y-3' }
        ];

        const BACKGROUND_STYLES: BackgroundOption[] = [
            { id: 'plain', name: 'Plain', bodyClass: 'bg-slate-50', cardClass: 'bg-white' },
            { id: 'grid', name: 'Grid', bodyClass: 'bg-slate-100 bg-[linear-gradient(#e2e8f0_1px,transparent_1px),linear-gradient(90deg,#e2e8f0_1px,transparent_1px)] bg-[size:32px_32px]', cardClass: 'bg-white/95 backdrop-blur-sm' },
            { id: 'gradient', name: 'Soft Gradient', bodyClass: 'bg-gradient-to-br from-slate-100 via-white to-blue-100', cardClass: 'bg-white/95' }
        ];

        const INITIAL_CV_DATA: CVData = {
            personalInfo: {
                name: 'Mohit Gaur',
                pronouns: 'he/him',
                tagline: 'Law Student | Interested in Public Policy & People-Centric Reform',
                email: 'mohitgaur22118@rgnul.ac.in',
                phone: '6397609838',
                location: 'Delhi, India',
                linkedin: 'https://www.linkedin.com/in/mohit-gaur-1590a2265/',
                github: 'github.com/mohitgaurRGNUL',
                website: 'mohitgaur22118-rgnul',
                calendly: '',
                image: 'https://picsum.photos/200/200'
            },
            sectionOrder: DEFAULT_SECTIONS,
            items: [
                {
                    id: 'profile-1',
                    section: 'Profile',
                    title: 'About Me',
                    content: "I'm a utopian empiricist aiming for the realisation of the interests of all. On one ordinary day in 2018, I started meeting and conversing with Indian legislators to table a private member's bill in Parliament to amend the Prevention of Cruelty to Animals Act, 1960. In essence, I'm a generalist targeting both breadth and depth of expertise in the evidence-based policy space in India.",
                    granularity: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'edu-1',
                    section: 'Education',
                    title: 'B.A. LL.B. (Hons), Law',
                    subtitle: 'The Rajiv Gandhi National University of Law, Patiala',
                    location: 'Patiala, Punjab',
                    date: '08/2022 – Present',
                    content: 'All India Rank: 864. Activities: Moot Court, Debate, ADR. Projects include Olga Tellis, grundnorm across constitutions, AI human privilege.',
                    granularity: [2, 3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'exp-1',
                    section: 'Experience',
                    title: 'Associate Editor',
                    subtitle: 'RGNUL Student Research Review (RSRR)',
                    location: 'Patiala, Punjab',
                    date: '08/2023 – 08/2024',
                    content: 'Reviewed incoming manuscripts; pitched impact investing, biosafety, and criminal law reforms.',
                    granularity: [3, 4, 5, 6, 7, 8, 9, 10]
                },
                {
                    id: 'exp-2',
                    section: 'Experience',
                    title: 'Intern',
                    subtitle: 'People For Animals Official',
                    location: 'Delhi, India',
                    date: '01/2023 – 01/2023',
                    content: 'Interned under Smt. Maneka Sanjay Gandhi. Effected meaningful functioning of official email. Rescued animals under Section 34 PCA Act 1960.',
                    granularity: [3, 4, 5, 6, 7, 8, 9, 10]
                }
            ]
        };

        const ANALYTICS_GUIDE_MD = `# Setting up Google Sheets Analytics for Granular CV

This guide explains how to create a backend for your CV using Google Sheets to track who views your CV and at what granularity.

## 1. Create a Google Sheet
1. Go to [sheets.google.com](https://sheets.google.com) and create a new sheet.
2. Name it "CV Analytics" (or anything you like).
3. In the first row, create these headers:
   - **A1**: timestamp
   - **B1**: employer
   - **C1**: durationSeconds
   - **D1**: maxScrollPercentage
   - **E1**: finalGranularity

## 2. Create the Apps Script
1. In your Google Sheet, go to **Extensions > Apps Script**.
2. Delete any code in the \`Code.gs\` file and paste the following:

\`\`\`javascript
function doPost(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);
    
    sheet.appendRow([
      data.timestamp,
      data.employer,
      data.durationSeconds,
      data.maxScrollPercentage,
      data.finalGranularity
    ]);
    
    return ContentService.createTextOutput(JSON.stringify({"status": "success"}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(error) {
    return ContentService.createTextOutput(JSON.stringify({"status": "error", "message": error.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
\`\`\`

## 3. Deploy as Web App
1. Click the blue **Deploy** button > **New deployment**.
2. Click the gear icon next to "Select type" and choose **Web app**.
3. Fill in the details:
   - **Description**: CV Analytics Receiver
   - **Execute as**: Me (your email)
   - **Who has access**: **Anyone** (This is crucial so the CV can send data without login).
4. Click **Deploy**.
5. Copy the **Web app URL** generated (it ends in \`/exec\`).

## 4. Use the URL
Paste this URL into the "Google Sheet Web App URL" field in the Granular CV Builder.
`;

        // --- SERVICE ---
        const generateCVHTML = (data: CVData, config: GeneratorConfig): string => {
            const serializedData = JSON.stringify(data).replace(/`/g, '\\`');
            const serializedConfig = JSON.stringify(config).replace(/`/g, '\\`');

            return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.personalInfo.name} - CV</title>
    <script src="https://cdn.tailwindcss.com"><\/script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Inter:wght@300;400;500;600&display=swap');
        body { font-family: 'Merriweather', serif; }
        .sans { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.35s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .print\:hidden { display: none !important; } }
    </style>
</head>
<body id="page-body" class="min-h-screen pb-20">
    <div class="sticky top-0 z-50 bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-200 p-4 print:hidden">
        <div class="max-w-4xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex flex-col w-full md:w-2/3">
                <div class="flex justify-between text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                    <span id="level-name">Level ${config.defaultLevel}: Loading...</span>
                    <span>Granularity ${config.levels.length}</span>
                </div>
                <input type="range" min="1" max="10" value="${config.defaultLevel}" id="granularity-slider" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
            </div>
            <div class="flex items-center gap-2">
                <div class="text-xs text-slate-500 font-mono hidden sm:block">Viewing as: <span class="font-bold">${config.employerName}</span></div>
                ${config.includeTestButton ? `<button onclick="testAnalytics()" class="ml-2 px-2 py-1 bg-amber-100 text-amber-800 text-xs rounded border border-amber-300 hover:bg-amber-200">Test Analytics</button>` : ''}
            </div>
        </div>
    </div>

    <main id="cv-root" class="max-w-5xl mx-auto mt-4 md:mt-8 mb-12 min-h-[1100px]"></main>
    <footer class="text-center text-slate-400 text-sm py-8 print:hidden"><p>Interactive CV generated for ${config.employerName}</p></footer>
    <script id="cv-data" type="application/json">${serializedData}<\/script>
    <script id="cv-config" type="application/json">${serializedConfig}<\/script>
    <script>
        (function() {
            const data = JSON.parse(document.getElementById('cv-data').textContent);
            const config = JSON.parse(document.getElementById('cv-config').textContent);
            const root = document.getElementById('cv-root');
            const body = document.getElementById('page-body');
            const slider = document.getElementById('granularity-slider');
            const levelNameLabel = document.getElementById('level-name');
            let startTime = Date.now();
            let maxScroll = 0;
            let currentLevel = parseInt(slider.value);

            const presetMap = {
                classic: { container: 'max-w-4xl mx-auto p-6 md:p-12 shadow-2xl', section: 'mb-8', sectionTitle: 'text-xl font-bold uppercase tracking-widest border-b-2 mb-4 pb-1', item: 'mb-5', header: 'text-center border-b pb-8 mb-8' },
                modern: { container: 'max-w-5xl mx-auto p-6 md:p-12 rounded-2xl shadow-xl', section: 'mb-6 p-5 rounded-xl border', sectionTitle: 'text-lg font-semibold mb-4', item: 'mb-4', header: 'p-8 rounded-2xl border mb-6' },
                compact: { container: 'max-w-3xl mx-auto p-4 md:p-8 shadow-lg', section: 'mb-4', sectionTitle: 'text-base font-bold uppercase mb-2', item: 'mb-3 text-sm', header: 'border-b pb-4 mb-4' },
                sidebar: { container: 'max-w-6xl mx-auto p-4 md:p-8 md:grid md:grid-cols-3 md:gap-8 shadow-xl', section: 'md:col-span-2 mb-6', sectionTitle: 'text-lg font-bold border-b pb-2 mb-3', item: 'mb-4', header: 'md:col-span-1 border rounded-xl p-5 mb-6 h-fit md:sticky md:top-24' },
                timeline: { container: 'max-w-4xl mx-auto p-6 md:p-12 shadow-xl', section: 'mb-8', sectionTitle: 'text-xl font-bold mb-4', item: 'mb-6 pl-6 border-l-2 relative', header: 'text-center mb-8' },
                ats: { container: 'max-w-4xl mx-auto p-6 md:p-10 border', section: 'mb-5', sectionTitle: 'text-lg font-bold uppercase mb-2', item: 'mb-3', header: 'border-b pb-4 mb-6' }
            };
            const paletteMap = {
                slate: { primary: '#0f172a', accent: '#2563eb', text: '#1e293b', muted: '#64748b', background: '#f8fafc' },
                emerald: { primary: '#064e3b', accent: '#059669', text: '#134e4a', muted: '#6b7280', background: '#f0fdf4' },
                violet: { primary: '#4c1d95', accent: '#7c3aed', text: '#312e81', muted: '#6b7280', background: '#f5f3ff' },
                charcoal: { primary: '#111827', accent: '#374151', text: '#111827', muted: '#4b5563', background: '#ffffff' }
            };
            const bgMap = {
                plain: 'background:#f8fafc;',
                grid: 'background-color:#f1f5f9;background-image:linear-gradient(#e2e8f0 1px,transparent 1px),linear-gradient(90deg,#e2e8f0 1px,transparent 1px);background-size:32px 32px;',
                gradient: 'background:linear-gradient(135deg,#e2e8f0 0%,#ffffff 50%,#dbeafe 100%);'
            };

            const spacingMap = {
                comfortable: { container: 'p-6 md:p-12', section: 'mb-8', item: 'mb-5' },
                airy: { container: 'p-8 md:p-14', section: 'mb-10', item: 'mb-6' },
                compact: { container: 'p-4 md:p-8', section: 'mb-4', item: 'mb-3' }
            };

            function render(level) {
                currentLevel = level;
                const activeConfig = config.levels.find(l => l.level === level) || config.levels[config.levels.length - 1];
                const preset = presetMap[config.layoutPreset] || presetMap.classic;
                const palette = paletteMap[config.colorPalette] || paletteMap.slate;
                const spacing = spacingMap[config.spacing] || spacingMap.comfortable;
                levelNameLabel.textContent = `Level ${level}: ${activeConfig.name}`;
                body.style.cssText = bgMap[config.backgroundStyle] || bgMap.plain;

                const itemsToShow = data.items.filter(item => item.granularity.includes(level));
                const grouped = itemsToShow.reduce((acc, item) => { if (!acc[item.section]) acc[item.section] = []; acc[item.section].push(item); return acc; }, {});
                const contact = [data.personalInfo.email, data.personalInfo.phone, data.personalInfo.location].filter(Boolean).join(' • ');
                const links = [
                    data.personalInfo.linkedin ? `<a href="${data.personalInfo.linkedin}" target="_blank" style="color:${palette.accent}">LinkedIn</a>` : '',
                    data.personalInfo.github ? `<a href="https://${data.personalInfo.github}" target="_blank" style="color:${palette.accent}">GitHub</a>` : '',
                    data.personalInfo.calendly ? `<a href="${data.personalInfo.calendly}" target="_blank" style="color:${palette.accent}">Meeting</a>` : ''
                ].filter(Boolean).join(' · ');

                const containerClass = preset.container.replace(/p-\d+\smd:p-\d+/, spacing.container);
                let html = `<article class="${containerClass} bg-white" style="color:${palette.text};border-color:${palette.accent}22;">
                    <header class="${preset.header} fade-in" style="border-color:${palette.primary};">
                        ${data.personalInfo.image ? `<img src="${data.personalInfo.image}" alt="Profile" class="w-28 h-28 rounded-full mx-auto mb-4 object-cover border-4" style="border-color:${palette.accent}22;">` : ''}
                        <h1 class="text-3xl md:text-4xl font-serif font-bold" style="color:${palette.primary};">${data.personalInfo.name}</h1>
                        ${data.personalInfo.pronouns ? `<div class="sans text-sm mt-1" style="color:${palette.muted};">${data.personalInfo.pronouns}</div>` : ''}
                        <p class="text-base italic mt-3">${data.personalInfo.tagline || ''}</p>
                        <div class="sans text-sm mt-3" style="color:${palette.muted};">${contact}</div>
                        <div class="sans text-sm mt-2">${links}</div>
                    </header>`;

                data.sectionOrder.forEach(section => {
                    if (!grouped[section] || grouped[section].length === 0) return;
                    const sectionClass = preset.section.replace(/mb-\d+/, spacing.section);
                    html += `<section class="${sectionClass} fade-in" data-section="${section}"><h2 class="${preset.sectionTitle}" style="border-color:${palette.primary};color:${palette.primary};">${section}</h2><div>`;
                    grouped[section].forEach(item => {
                        const timelineDot = config.layoutPreset === 'timeline' ? `<span style="width:10px;height:10px;background:${palette.accent};position:absolute;left:-6px;top:6px;border-radius:999px;"></span>` : '';
                        const itemClass = preset.item.replace(/mb-\d+/, spacing.item);
                        html += `<div class="${itemClass}">${timelineDot}<div class="flex flex-col md:flex-row md:justify-between md:items-baseline gap-1"><h3 class="font-bold" style="color:${palette.primary};">${item.title}</h3>${item.date ? `<span class="sans text-xs" style="color:${palette.muted};">${item.date}</span>` : ''}</div>${item.subtitle ? `<div class="italic text-sm">${item.subtitle}</div>` : ''}${item.location ? `<div class="sans text-xs" style="color:${palette.muted};">${item.location}</div>` : ''}<div class="text-sm leading-relaxed mt-1">${item.content}</div></div>`;
                    });
                    html += `</div></section>`;
                });
                html += `</article>`;
                root.innerHTML = html;
            }

            slider.addEventListener('input', (e) => render(parseInt(e.target.value)));
            window.addEventListener('scroll', () => { const y = window.scrollY; if (y > maxScroll) maxScroll = y; });
            function getAnalyticsPayload() { const duration = Math.floor((Date.now()-startTime)/1000); const scrollPercentage = Math.round((maxScroll / (document.documentElement.scrollHeight - window.innerHeight)) * 100); return { employer: config.employerName, timestamp: new Date().toISOString(), durationSeconds: duration, maxScrollPercentage: scrollPercentage, finalGranularity: currentLevel }; }
            function sendAnalytics(isTest=false) { if (!config.googleSheetUrl) { if(isTest) alert('No Google Sheet URL configured.'); return; } fetch(config.googleSheetUrl, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify(getAnalyticsPayload()) }).then(() => { if(isTest) alert('Data sent to Google Sheets (no-cors mode). Check your sheet.'); }).catch(err => { if(isTest) alert('Error sending: '+err); }); }
            window.testAnalytics = function() { const payload = getAnalyticsPayload(); const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'analytics_test_payload.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); sendAnalytics(true); };
            setInterval(() => sendAnalytics(false), 15000);
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden') sendAnalytics(false); });
            render(config.defaultLevel);
        })();
    <\/script>
</body>
</html>`;
        };

        // --- COMPONENTS ---
        const Icons = {
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Edit: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>,
            ArrowUp: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>,
            ArrowDown: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            List: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        };

        const App = () => {
            const [cvData, setCvData] = useState(INITIAL_CV_DATA);
            const [levels, setLevels] = useState(DEFAULT_LEVELS);
            const [activeTab, setActiveTab] = useState('content');
            
            // Generation Config State
            const [employerName, setEmployerName] = useState('');
            const [sheetUrl, setSheetUrl] = useState('');
            const [defaultLevel, setDefaultLevel] = useState(5);
            const [includeTestButton, setIncludeTestButton] = useState(true);
            const [layoutPreset, setLayoutPreset] = useState('classic');
            const [colorPalette, setColorPalette] = useState('slate');
            const [spacing, setSpacing] = useState('comfortable');
            const [backgroundStyle, setBackgroundStyle] = useState('plain');

            // PDF Import State
            const fileInputRef = useRef(null);
            const [isImporting, setIsImporting] = useState(false);
            
            // Section Management State
            const [newSectionName, setNewSectionName] = useState('');

            // --- Handlers ---

            const handleLevelToggle = (itemId, level) => {
                setCvData(prev => ({
                    ...prev,
                    items: prev.items.map(item => {
                        if (item.id !== itemId) return item;
                        const newLevels = item.granularity.includes(level)
                        ? item.granularity.filter(l => l !== level)
                        : [...item.granularity, level].sort((a, b) => a - b);
                        return { ...item, granularity: newLevels };
                    })
                }));
            };

            const handleAddItem = () => {
                const newItem: CVItem = {
                    id: 'new-' + Date.now(),
                    section: cvData.sectionOrder[0] || 'Experience',
                    title: 'New Position',
                    content: 'Description here...',
                    granularity: [5, 6, 7, 8, 9, 10]
                };
                setCvData(prev => ({ ...prev, items: [newItem, ...prev.items] }));
            };

            const handleDeleteItem = (id) => {
                if(confirm('Are you sure you want to delete this item?')) {
                    setCvData(prev => ({ ...prev, items: prev.items.filter(i => i.id !== id) }));
                }
            };

            const handleMoveItem = (index, direction) => {
                const newItems = [...cvData.items];
                if (direction === -1 && index > 0) {
                    [newItems[index], newItems[index - 1]] = [newItems[index - 1], newItems[index]];
                } else if (direction === 1 && index < newItems.length - 1) {
                    [newItems[index], newItems[index + 1]] = [newItems[index + 1], newItems[index]];
                }
                setCvData(prev => ({ ...prev, items: newItems }));
            };

            const handleImportPDF = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;

                setIsImporting(true);
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(" ");
                        fullText += pageText + "\n";
                    }

                    const newItems = [];
                    
                    // Basic heuristic: check if we have an "Imported" section, if not add it
                    if(!cvData.sectionOrder.includes('Imported')) {
                        setCvData(prev => ({...prev, sectionOrder: [...prev.sectionOrder, 'Imported']}));
                    }

                    newItems.push({
                        id: 'import-' + Date.now(),
                        section: 'Imported',
                        title: 'Imported PDF Content',
                        subtitle: 'Please manually separate this into items',
                        content: fullText,
                        granularity: [1,2,3,4,5,6,7,8,9,10]
                    });
                    
                    setCvData(prev => ({
                        ...prev,
                        items: [...prev.items, ...newItems]
                    }));
                    
                    alert('PDF Imported! Content added to the bottom of the list. Please refine.');

                } catch (err) {
                    console.error(err);
                    alert("Failed to parse PDF. Make sure it is a valid PDF.");
                } finally {
                    setIsImporting(false);
                    if(fileInputRef.current) fileInputRef.current.value = '';
                }
            };
            
            const handleImageChange = (e) => {
                const file = e.target.files?.[0];
                if(file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setCvData(prev => ({...prev, personalInfo: {...prev.personalInfo, image: reader.result}}));
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleAddSection = () => {
                if(newSectionName && !cvData.sectionOrder.includes(newSectionName)) {
                    setCvData(prev => ({...prev, sectionOrder: [...prev.sectionOrder, newSectionName]}));
                    setNewSectionName('');
                }
            };

            const handleDeleteSection = (section) => {
                if(confirm(`Delete section "${section}"? Items in this section will NOT be deleted, but you should reassign them.`)) {
                    setCvData(prev => ({...prev, sectionOrder: prev.sectionOrder.filter(s => s !== section)}));
                }
            };

            const handleMoveSection = (index, direction) => {
                const newOrder = [...cvData.sectionOrder];
                if (direction === -1 && index > 0) {
                    [newOrder[index], newOrder[index - 1]] = [newOrder[index - 1], newOrder[index]];
                } else if (direction === 1 && index < newOrder.length - 1) {
                    [newOrder[index], newOrder[index + 1]] = [newOrder[index + 1], newOrder[index]];
                }
                setCvData(prev => ({...prev, sectionOrder: newOrder}));
            };

            const buildPreviewConfig = (presetId) => ({
                employerName: employerName || 'Preview Mode',
                googleSheetUrl: '',
                defaultLevel,
                levels,
                includeTestButton: false,
                layoutPreset: presetId,
                colorPalette,
                spacing,
                backgroundStyle
            });

            const handleDownload = () => {
                if (!employerName) {
                    alert("Please enter an employer name for tracking.");
                    return;
                }
                
                const config = {
                    employerName,
                    googleSheetUrl: sheetUrl,
                    defaultLevel,
                    levels,
                    includeTestButton,
                    layoutPreset,
                    colorPalette,
                    spacing,
                    backgroundStyle
                };

                const htmlContent = generateCVHTML(cvData, config);
                const blobHtml = new Blob([htmlContent], { type: 'text/html' });
                const urlHtml = URL.createObjectURL(blobHtml);
                const aHtml = document.createElement('a');
                aHtml.href = urlHtml;
                aHtml.download = `${employerName.replace(/\s+/g, '_')}_CV.html`;
                document.body.appendChild(aHtml);
                aHtml.click();
                document.body.removeChild(aHtml);
                URL.revokeObjectURL(urlHtml);

                setTimeout(() => {
                    const blobMd = new Blob([ANALYTICS_GUIDE_MD], { type: 'text/markdown' });
                    const urlMd = URL.createObjectURL(blobMd);
                    const aMd = document.createElement('a');
                    aMd.href = urlMd;
                    aMd.download = 'README_ANALYTICS.md';
                    document.body.appendChild(aMd);
                    aMd.click();
                    document.body.removeChild(aMd);
                    URL.revokeObjectURL(urlMd);
                }, 500);
            };

            return (
                <div className="min-h-screen bg-gray-50 flex flex-col font-sans pb-12 sm:pb-0">
                {/* Navbar */}
                <nav className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-20">
                    <div className="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
                        <div className="flex items-center gap-2">
                            <span className="text-xl font-bold tracking-tight">GranularCV</span>
                            <span className="bg-blue-600 text-xs px-2 py-0.5 rounded-full">Builder</span>
                        </div>
                        <div className="flex overflow-x-auto gap-2 w-full sm:w-auto pb-1 sm:pb-0 no-scrollbar">
                            <button 
                                onClick={() => setActiveTab('content')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'content' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.Edit /> Content
                            </button>
                            <button 
                                onClick={() => setActiveTab('sections')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'sections' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.List /> Sections
                            </button>
                            <button 
                                onClick={() => setActiveTab('granularity')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'granularity' ? 'bg-slate-700' : 'hover:bg-slate-800'}`}
                            >
                                <Icons.Settings /> Granularity
                            </button>
                            <button 
                                onClick={() => setActiveTab('generate')}
                                className={`whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${activeTab === 'generate' ? 'bg-green-700 hover:bg-green-600' : 'bg-slate-700 hover:bg-slate-800'}`}
                            >
                                <Icons.Download /> Generate
                            </button>
                        </div>
                    </div>
                </nav>

                {/* Main Content */}
                <main className="flex-1 max-w-7xl mx-auto w-full p-4 sm:p-6">
                    
                    {/* TAB: CONTENT EDITOR */}
                    {activeTab === 'content' && (
                    <div className="space-y-6">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h2 className="text-lg font-bold text-slate-800 mb-4">Personal Info</h2>
                        <div className="flex flex-col md:flex-row gap-6">
                            <div className="flex flex-col items-center gap-3">
                                <div className="w-32 h-32 rounded-full overflow-hidden border-4 border-slate-100 bg-slate-100 relative group">
                                    <img src={cvData.personalInfo.image || 'https://via.placeholder.com/150'} className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        <span className="text-white text-xs font-bold">Change</span>
                                    </div>
                                    <input type="file" accept="image/*" onChange={handleImageChange} className="absolute inset-0 opacity-0 cursor-pointer" />
                                </div>
                                <span className="text-xs text-slate-400">Tap to upload</span>
                            </div>
                            <div className="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.name} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, name: e.target.value}})}
                                placeholder="Full Name"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.pronouns} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, pronouns: e.target.value}})}
                                placeholder="Pronouns (e.g. he/him)"
                                />
                                <input 
                                className="border p-2 rounded md:col-span-2" 
                                value={cvData.personalInfo.tagline} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, tagline: e.target.value}})}
                                placeholder="Tagline / Headline"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.calendly} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, calendly: e.target.value}})}
                                placeholder="Calendly Link (Optional)"
                                />
                                <input 
                                className="border p-2 rounded" 
                                value={cvData.personalInfo.linkedin} 
                                onChange={e => setCvData({...cvData, personalInfo: {...cvData.personalInfo, linkedin: e.target.value}})}
                                placeholder="LinkedIn URL"
                                />
                            </div>
                        </div>
                        </div>

                        <div className="space-y-4">
                        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200 gap-4">
                            <h2 className="text-lg font-bold text-slate-800">CV Items</h2>
                            <div className="flex flex-wrap gap-2 w-full sm:w-auto">
                                <button 
                                    onClick={handleAddItem}
                                    className="flex-1 sm:flex-none text-sm bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 flex items-center justify-center gap-2 font-medium"
                                >
                                    <Icons.Plus /> Add Item
                                </button>
                                <div className="flex-1 sm:flex-none relative overflow-hidden">
                                    <button className="w-full text-sm bg-slate-100 text-slate-700 px-3 py-2 rounded hover:bg-slate-200 border border-slate-300 flex items-center justify-center gap-2">
                                        {isImporting ? 'Parsing...' : 'Import PDF'}
                                    </button>
                                    <input 
                                        type="file" 
                                        accept=".pdf" 
                                        ref={fileInputRef}
                                        onChange={handleImportPDF}
                                        className="absolute inset-0 opacity-0 cursor-pointer"
                                        disabled={isImporting}
                                    />
                                </div>
                            </div>
                        </div>
                        
                        {cvData.items.map((item, idx) => (
                            <div key={item.id} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:border-blue-300 transition-colors relative group">
                            
                            {/* Controls */}
                            <div className="absolute top-4 right-4 flex items-center gap-2 z-10">
                                <button onClick={() => handleMoveItem(idx, -1)} disabled={idx === 0} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowUp /></button>
                                <button onClick={() => handleMoveItem(idx, 1)} disabled={idx === cvData.items.length - 1} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowDown /></button>
                                <button onClick={() => handleDeleteItem(item.id)} className="p-1 text-slate-400 hover:text-red-600"><Icons.Trash /></button>
                            </div>

                            <div className="flex justify-between items-start mb-4">
                                <div className="flex-1 mr-0 sm:mr-12">
                                <div className="flex gap-2 mb-2">
                                    <select 
                                        value={item.section}
                                        onChange={(e) => {
                                            const newItems = [...cvData.items];
                                            newItems[idx].section = e.target.value;
                                            setCvData({...cvData, items: newItems});
                                        }}
                                        className="text-xs font-bold uppercase text-slate-500 tracking-wider bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none max-w-full"
                                    >
                                        {cvData.sectionOrder.map(s => <option key={s} value={s}>{s}</option>)}
                                        {!cvData.sectionOrder.includes('Imported') && <option value="Imported">Imported</option>}
                                    </select>
                                </div>
                                <input 
                                    value={item.title} 
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].title = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Title"
                                    className="text-lg font-bold text-slate-900 w-full border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none transition-colors mb-1"
                                />
                                <input 
                                    value={item.subtitle || ''} 
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].subtitle = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Subtitle"
                                    className="text-sm font-medium text-slate-600 w-full border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none transition-colors mb-2"
                                />
                                <textarea
                                    value={item.content}
                                    onChange={(e) => {
                                        const newItems = [...cvData.items];
                                        newItems[idx].content = e.target.value;
                                        setCvData({...cvData, items: newItems});
                                    }}
                                    placeholder="Description / Content..."
                                    className="w-full text-sm text-slate-600 mt-2 p-2 border border-transparent hover:border-gray-200 focus:border-blue-200 rounded outline-none h-24 resize-y bg-slate-50"
                                />
                                </div>
                            </div>

                            {/* Granularity Toggles */}
                            <div className="mt-4 pt-4 border-t border-gray-100">
                                <p className="text-xs font-semibold text-slate-400 mb-2 uppercase flex items-center gap-2">
                                    Visible at Levels:
                                    <span className="text-[10px] font-normal text-slate-400 normal-case">(Click to toggle)</span>
                                </p>
                                <div className="flex flex-wrap gap-1">
                                {levels.map((lvl) => (
                                    <button
                                    key={lvl.level}
                                    onClick={() => handleLevelToggle(item.id, lvl.level)}
                                    className={`w-8 h-8 rounded-full text-xs font-medium flex items-center justify-center transition-all ${
                                        item.granularity.includes(lvl.level)
                                        ? 'bg-blue-600 text-white shadow-md scale-105'
                                        : 'bg-gray-100 text-gray-400 hover:bg-gray-200'
                                    }`}
                                    title={lvl.name}
                                    >
                                    {lvl.level}
                                    </button>
                                ))}
                                </div>
                            </div>
                            </div>
                        ))}
                        </div>
                    </div>
                    )}
                    
                    {/* TAB: SECTIONS MANAGER */}
                    {activeTab === 'sections' && (
                        <div className="max-w-3xl mx-auto space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <h2 className="text-xl font-bold text-slate-900 mb-2">Manage Sections</h2>
                                <p className="text-slate-500 mb-6 text-sm">Add, remove, or reorder sections. The order here determines the order in the final CV.</p>
                                
                                <div className="flex gap-2 mb-6">
                                    <input 
                                        value={newSectionName}
                                        onChange={(e) => setNewSectionName(e.target.value)}
                                        placeholder="New Section Name (e.g. References)"
                                        className="flex-1 p-2 border border-gray-300 rounded outline-none focus:border-blue-500"
                                    />
                                    <button 
                                        onClick={handleAddSection}
                                        disabled={!newSectionName}
                                        className="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        Add
                                    </button>
                                </div>

                                <div className="space-y-2">
                                    {cvData.sectionOrder.map((section, idx) => (
                                        <div key={section} className="flex items-center justify-between p-3 bg-slate-50 border border-slate-200 rounded group">
                                            <span className="font-medium text-slate-700">{section}</span>
                                            <div className="flex items-center gap-2">
                                                <button onClick={() => handleMoveSection(idx, -1)} disabled={idx === 0} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowUp /></button>
                                                <button onClick={() => handleMoveSection(idx, 1)} disabled={idx === cvData.sectionOrder.length - 1} className="p-1 text-slate-400 hover:text-blue-600 disabled:opacity-30"><Icons.ArrowDown /></button>
                                                <button onClick={() => handleDeleteSection(section)} className="p-1 text-slate-400 hover:text-red-600"><Icons.Trash /></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* TAB: GRANULARITY SETTINGS */}
                    {activeTab === 'granularity' && (
                    <div className="max-w-3xl mx-auto">
                        <h2 className="text-2xl font-bold text-slate-900 mb-6">Granularity Levels</h2>
                        <p className="text-slate-500 mb-8">Define the name and purpose of each detail level. This matches the UI shown in the generated CV.</p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {levels.map((lvl, idx) => (
                            <div key={lvl.level} className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <div className="flex items-center gap-3 mb-3">
                                <div className="w-8 h-8 bg-blue-100 text-blue-700 rounded-full flex items-center justify-center font-bold">
                                {lvl.level}
                                </div>
                                <input 
                                value={lvl.name}
                                onChange={(e) => {
                                    const newLevels = [...levels];
                                    newLevels[idx].name = e.target.value;
                                    setLevels(newLevels);
                                }}
                                className="font-bold text-slate-800 border-b border-transparent focus:border-blue-500 outline-none w-full"
                                />
                            </div>
                            <input 
                                value={lvl.description}
                                onChange={(e) => {
                                const newLevels = [...levels];
                                newLevels[idx].description = e.target.value;
                                setLevels(newLevels);
                                }}
                                className="w-full text-sm text-slate-500 border border-transparent hover:border-gray-200 p-1 rounded"
                            />
                            </div>
                        ))}
                        </div>
                    </div>
                    )}

                    {/* TAB: GENERATE */}
                    {activeTab === 'generate' && (
                    <div className="max-w-2xl mx-auto mt-4 sm:mt-12">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-8 text-white">
                            <h2 className="text-3xl font-bold mb-2">Export CV</h2>
                            <p className="text-slate-300">Generate a unique, tracked HTML file for a specific employer.</p>
                        </div>
                        
                        <div className="p-8 space-y-6">
                            <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Employer / Recipient Name</label>
                            <input 
                                type="text" 
                                value={employerName}
                                onChange={(e) => setEmployerName(e.target.value)}
                                placeholder="e.g. Acme Corp, Hiring Manager"
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                            <p className="text-xs text-slate-500 mt-1">This name will be logged in analytics and shown in the footer.</p>
                            </div>

                            <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">Google Sheet Web App URL (Optional)</label>
                            <input 
                                type="text" 
                                value={sheetUrl}
                                onChange={(e) => setSheetUrl(e.target.value)}
                                placeholder="https://script.google.com/macros/s/..."
                                className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm"
                            />
                            <p className="text-xs text-slate-500 mt-1">Deploy a Google Apps Script to receive POST requests with JSON payloads.</p>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2">Layout Preset</label>
                                    <select value={layoutPreset} onChange={(e) => setLayoutPreset(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg">
                                        {LAYOUT_PRESETS.map((preset) => <option key={preset.id} value={preset.id}>{preset.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2">Color Palette</label>
                                    <select value={colorPalette} onChange={(e) => setColorPalette(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg">
                                        {COLOR_PALETTES.map((palette) => <option key={palette.id} value={palette.id}>{palette.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2">Spacing</label>
                                    <select value={spacing} onChange={(e) => setSpacing(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg">
                                        {SPACING_PRESETS.map((space) => <option key={space.id} value={space.id}>{space.name}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-semibold text-slate-700 mb-2">Background Style</label>
                                    <select value={backgroundStyle} onChange={(e) => setBackgroundStyle(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg">
                                        {BACKGROUND_STYLES.map((bg) => <option key={bg.id} value={bg.id}>{bg.name}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">Responsive Template Preview</label>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    {LAYOUT_PRESETS.map((preset) => (
                                        <div key={preset.id} className={`rounded-xl border ${layoutPreset === preset.id ? 'border-blue-500 ring-2 ring-blue-200' : 'border-slate-200'} overflow-hidden bg-slate-50`}>
                                            <button onClick={() => setLayoutPreset(preset.id)} className="w-full text-left p-3 bg-white border-b border-slate-200">
                                                <div className="font-semibold text-slate-800">{preset.name}</div>
                                                <div className="text-xs text-slate-500">{preset.description}</div>
                                            </button>
                                            <div className="h-56">
                                                <iframe title={`${preset.name} preview`} className="w-full h-full" srcDoc={generateCVHTML(cvData, buildPreviewConfig(preset.id))} />
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-semibold text-slate-700 mb-2">Default Granularity Level</label>
                                <div className="flex items-center gap-4">
                                    <input 
                                        type="range" 
                                        min="1" 
                                        max="10" 
                                        value={defaultLevel} 
                                        onChange={(e) => setDefaultLevel(parseInt(e.target.value))}
                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                    />
                                    <span className="font-bold text-blue-600 w-8">{defaultLevel}</span>
                                </div>
                            </div>

                            <div className="flex items-center gap-3 py-2">
                                <input 
                                    type="checkbox" 
                                    id="testBtn"
                                    checked={includeTestButton}
                                    onChange={(e) => setIncludeTestButton(e.target.checked)}
                                    className="w-4 h-4 text-blue-600 rounded"
                                />
                                <label htmlFor="testBtn" className="text-sm text-slate-700">Include "Test Analytics" button in generated CV?</label>
                            </div>

                            <div className="pt-4 border-t border-gray-100">
                            <button 
                                onClick={handleDownload}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-transform transform active:scale-95 flex items-center justify-center gap-2"
                            >
                                <Icons.Download /> Download Single-File HTML & Guide
                            </button>
                            </div>
                        </div>
                        </div>
                    </div>
                    )}
                </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
